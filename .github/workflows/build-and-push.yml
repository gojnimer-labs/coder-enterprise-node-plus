name: Build and Push Docker Image

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # Run daily to check for updates
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      code_server_version: ${{ steps.versions.outputs.code_server_version }}
      claude_code_version: ${{ steps.versions.outputs.claude_code_version }}
      base_image_version: ${{ steps.versions.outputs.base_image_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest versions
        id: versions
        run: |
          # Get latest code-server version
          CODE_SERVER_VERSION=$(curl -sL https://api.github.com/repos/coder/code-server/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          echo "code_server_version=$CODE_SERVER_VERSION" >> $GITHUB_OUTPUT
          echo "Latest code-server version: $CODE_SERVER_VERSION"

          # Get latest claude-code version from npm registry
          CLAUDE_CODE_VERSION=$(curl -sL https://registry.npmjs.org/@anthropic-ai/claude-code/latest | jq -r '.version')
          if [ "$CLAUDE_CODE_VERSION" = "null" ] || [ -z "$CLAUDE_CODE_VERSION" ]; then
            CLAUDE_CODE_VERSION="latest"
          fi
          echo "claude_code_version=$CLAUDE_CODE_VERSION" >> $GITHUB_OUTPUT
          echo "Latest claude-code version: $CLAUDE_CODE_VERSION"

          # Get latest codercom/enterprise-node base image digest
          BASE_IMAGE_DIGEST=$(curl -sL https://hub.docker.com/v2/repositories/codercom/enterprise-node/tags/latest | jq -r '.digest' | cut -c8-19)
          if [ "$BASE_IMAGE_DIGEST" = "null" ] || [ -z "$BASE_IMAGE_DIGEST" ]; then
            BASE_IMAGE_DIGEST="unknown"
          fi
          echo "base_image_version=$BASE_IMAGE_DIGEST" >> $GITHUB_OUTPUT
          echo "Latest enterprise-node digest: $BASE_IMAGE_DIGEST"

      - name: Check if build is needed
        id: check
        run: |
          # Always build on push to main or manual trigger
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "Build triggered by push or manual dispatch"
            exit 0
          fi

          # For scheduled runs, check if versions have changed
          # This is a simple implementation - you can enhance it by storing previous versions
          echo "should_build=true" >> $GITHUB_OUTPUT

  build-and-push:
    needs: check-versions
    if: needs.check-versions.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-
            type=ref,event=branch
            type=ref,event=pr
            type=raw,value=code-server-${{ needs.check-versions.outputs.code_server_version }}
            type=raw,value=claude-code-${{ needs.check-versions.outputs.claude_code_version }}
            type=raw,value=base-${{ needs.check-versions.outputs.base_image_version }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            CODE_SERVER_VERSION=${{ needs.check-versions.outputs.code_server_version }}
            CLAUDE_CODE_VERSION=${{ needs.check-versions.outputs.claude_code_version }}

      - name: Image digest
        run: echo "Image pushed with digest ${{ steps.build-push.outputs.digest }}"

      - name: Generate release tag
        id: release_tag
        run: |
          RELEASE_TAG="v$(date +'%Y.%m.%d-%H%M%S')"
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $RELEASE_TAG"

      - name: Get previous release tag
        id: previous_release
        run: |
          PREV_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
          echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous release tag: $PREV_TAG"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if versions changed
        id: version_check
        run: |
          CODE_SERVER_VERSION="${{ needs.check-versions.outputs.code_server_version }}"
          CLAUDE_CODE_VERSION="${{ needs.check-versions.outputs.claude_code_version }}"
          BASE_IMAGE_VERSION="${{ needs.check-versions.outputs.base_image_version }}"

          # Get the latest release body and extract versions
          LATEST_RELEASE_BODY=$(gh release view --json body --jq '.body' 2>/dev/null || echo "")

          if [ -z "$LATEST_RELEASE_BODY" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "✅ No previous release - will create release"
          else
            # Extract versions from latest release body
            PREV_CODE_SERVER=$(echo "$LATEST_RELEASE_BODY" | grep -oP 'code-server.*?`\K[0-9.]+' | head -1 || echo "")
            PREV_CLAUDE_CODE=$(echo "$LATEST_RELEASE_BODY" | grep -oP 'claude-code.*?`\K[0-9.]+' | head -1 || echo "")
            PREV_BASE_IMAGE=$(echo "$LATEST_RELEASE_BODY" | grep -oP 'Base Image.*?`\K[a-f0-9]+' | head -1 || echo "")

            echo "Previous versions: code-server=$PREV_CODE_SERVER, claude-code=$PREV_CLAUDE_CODE, base-image=$PREV_BASE_IMAGE"
            echo "Current versions: code-server=$CODE_SERVER_VERSION, claude-code=$CLAUDE_CODE_VERSION, base-image=$BASE_IMAGE_VERSION"

            if [ "$PREV_CODE_SERVER" = "$CODE_SERVER_VERSION" ] && [ "$PREV_CLAUDE_CODE" = "$CLAUDE_CODE_VERSION" ] && [ "$PREV_BASE_IMAGE" = "$BASE_IMAGE_VERSION" ]; then
              # Versions are the same, but check if there are new commits
              PREV_TAG="${{ steps.previous_release.outputs.previous_tag }}"
              if [ -n "$PREV_TAG" ]; then
                COMMIT_COUNT=$(git rev-list ${PREV_TAG}..HEAD --count 2>/dev/null || echo "0")
                if [ "$COMMIT_COUNT" -gt "0" ]; then
                  echo "should_release=true" >> $GITHUB_OUTPUT
                  echo "✅ $COMMIT_COUNT new commit(s) since last release - will create release"
                else
                  echo "should_release=false" >> $GITHUB_OUTPUT
                  echo "⏭️  No changes since last release - skipping"
                fi
              else
                echo "should_release=false" >> $GITHUB_OUTPUT
                echo "⏭️  Versions unchanged - skipping release"
              fi
            else
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "✅ Version change detected - will create release"
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate changelog
        if: steps.version_check.outputs.should_release == 'true'
        id: changelog
        run: |
          CODE_SERVER_VERSION="${{ needs.check-versions.outputs.code_server_version }}"
          CLAUDE_CODE_VERSION="${{ needs.check-versions.outputs.claude_code_version }}"
          BASE_IMAGE_VERSION="${{ needs.check-versions.outputs.base_image_version }}"
          RELEASE_TAG="${{ steps.release_tag.outputs.release_tag }}"
          PREV_TAG="${{ steps.previous_release.outputs.previous_tag }}"

          CHANGELOG="## What's Changed\n\n"
          CHANGELOG+="### Included Versions\n\n"
          CHANGELOG+="- **code-server**: \`${CODE_SERVER_VERSION}\` ([Release Notes](https://github.com/coder/code-server/releases/tag/v${CODE_SERVER_VERSION}))\n"
          if [ "$CLAUDE_CODE_VERSION" = "latest" ]; then
            CHANGELOG+="- **claude-code**: \`${CLAUDE_CODE_VERSION}\` ([npm Package](https://www.npmjs.com/package/@anthropic-ai/claude-code))\n"
          else
            CHANGELOG+="- **claude-code**: \`${CLAUDE_CODE_VERSION}\` ([npm Package](https://www.npmjs.com/package/@anthropic-ai/claude-code/v/${CLAUDE_CODE_VERSION}))\n"
          fi
          CHANGELOG+="- **Base Image**: \`codercom/enterprise-node:latest\` (digest: \`${BASE_IMAGE_VERSION}\`)\n\n"

          CHANGELOG+="### Docker Images\n\n"
          CHANGELOG+="Pull this release:\n"
          CHANGELOG+="\`\`\`bash\n"
          CHANGELOG+="docker pull ghcr.io/${{ github.repository }}:latest\n"
          CHANGELOG+="# Or use version-specific tags:\n"
          CHANGELOG+="docker pull ghcr.io/${{ github.repository }}:code-server-${CODE_SERVER_VERSION}\n"
          CHANGELOG+="docker pull ghcr.io/${{ github.repository }}:claude-code-${CLAUDE_CODE_VERSION}\n"
          CHANGELOG+="docker pull ghcr.io/${{ github.repository }}:base-${BASE_IMAGE_VERSION}\n"
          CHANGELOG+="\`\`\`\n\n"

          if [[ -n "$PREV_TAG" ]]; then
            CHANGELOG+="### Commits Since Last Release\n\n"
            CHANGELOG+="\`\`\`\n"
            CHANGELOG+="$(git log ${PREV_TAG}..HEAD --oneline --no-decorate 2>/dev/null || echo 'No previous release to compare')\n"
            CHANGELOG+="\`\`\`\n\n"
          fi

          CHANGELOG+="### Build Information\n\n"
          CHANGELOG+="- **Build Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')\n"
          CHANGELOG+="- **Commit**: \`${{ github.sha }}\`\n"
          CHANGELOG+="- **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n"
          CHANGELOG+="- **Triggered by**: ${{ github.event_name }}\n"

          # Save to file for release creation
          echo -e "$CHANGELOG" > /tmp/changelog.md
          cat /tmp/changelog.md
          echo "changelog_file=/tmp/changelog.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.version_check.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.release_tag.outputs.release_tag }}" \
            --title "Release ${{ steps.release_tag.outputs.release_tag }}" \
            --notes-file "${{ steps.changelog.outputs.changelog_file }}"

          echo "✅ Release created: ${{ steps.release_tag.outputs.release_tag }}"
